{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4 text-gray-800">容器详情 - {{ container.name }}</h1>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- 基本信息 -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">基本信息</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>容器ID:</strong></td>
                                    <td>{{ container.container_id or 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>名称:</strong></td>
                                    <td>{{ container.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>状态:</strong></td>
                                    <td>
                                        {% if container.status == 'running' %}
                                            <span class="badge badge-success">运行中</span>
                                        {% elif container.status == 'stopped' or container.status == 'exited' %}
                                            <span class="badge badge-secondary">已停止</span>
                                        {% elif container.status == 'error' %}
                                            <span class="badge badge-danger">错误</span>
                                        {% else %}
                                            <span class="badge badge-warning">{{ container.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>镜像:</strong></td>
                                    <td>{{ container.image }}</td>
                                </tr>
                                <tr>
                                    <td><strong>引擎:</strong></td>
                                    <td>{{ container.engine.name }} ({{ container.engine.engine_type }})</td>
                                </tr>
                                <tr>
                                    <td><strong>创建时间:</strong></td>
                                    <td>{{ container.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                                <tr>
                                    <td><strong>更新时间:</strong></td>
                                    <td>{{ container.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- 资源使用 -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">资源使用</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>CPU使用</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 style="width: {{ container.cpu_usage or 0 }}%" 
                                                 aria-valuenow="{{ container.cpu_usage or 0 }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ "%.1f"|format(container.cpu_usage or 0) }}%
                                            </div>
                                        </div>
                                        <small class="text-muted">限制: {{ container.cpu_limit }} 核心</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>内存使用</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-info" role="progressbar" 
                                                 style="width: {{ container.memory_usage_percent or 0 }}%" 
                                                 aria-valuenow="{{ container.memory_usage_percent or 0 }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ container.memory_usage or '0' }} MB / {{ container.memory_limit }} MB
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>存储使用</label>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" role="progressbar" 
                                                 style="width: {{ container.storage_usage_percent or 0 }}%" 
                                                 aria-valuenow="{{ container.storage_usage_percent or 0 }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ container.storage_usage or '0' }} GB / {{ container.storage_limit }} GB
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>网络I/O</label>
                                        <p class="form-control-static">
                                            接收: {{ container.network_rx or '0' }} MB<br>
                                            发送: {{ container.network_tx or '0' }} MB
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- 操作按钮 -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">操作</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                {% if container.status == 'running' %}
                                <button class="btn btn-warning" id="stopContainer">
                                    <i class="fas fa-stop"></i> 停止容器
                                </button>
                                <a href="{{ url_for('main.terminal', container_id=container.id) }}" class="btn btn-info">
                                    <i class="fas fa-terminal"></i> 终端
                                </a>
                                {% else %}
                                <button class="btn btn-success" id="startContainer">
                                    <i class="fas fa-play"></i> 启动容器
                                </button>
                                {% endif %}
                                
                                <button class="btn btn-danger" id="deleteContainer">
                                    <i class="fas fa-trash"></i> 删除容器
                                </button>
                                
                                <a href="{{ url_for('main.containers') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> 返回列表
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- 端口映射 -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">端口映射</h6>
                        </div>
                        <div class="card-body">
                            {% if container.port_mappings %}
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>主机端口</th>
                                        <th>容器端口</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mapping in container.port_mappings.split(',') %}
                                    {% set ports = mapping.split(':') %}
                                    {% if ports|length == 2 %}
                                    <tr>
                                        <td>{{ ports[0].strip() }}</td>
                                        <td>{{ ports[1].strip() }}</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-muted">无端口映射</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 环境变量 -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">环境变量</h6>
                        </div>
                        <div class="card-body">
                            {% if container.environment_vars %}
                            <table class="table table-sm">
                                <tbody>
                                    {% for env_var in container.environment_vars.split(',') %}
                                    {% set parts = env_var.split('=', 1) %}
                                    {% if parts|length == 2 %}
                                    <tr>
                                        <td><strong>{{ parts[0].strip() }}</strong></td>
                                        <td>{{ parts[1].strip() }}</td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-muted">无环境变量</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 启动容器
    $('#startContainer').click(function() {
        if (confirm('确定要启动这个容器吗？')) {
            $.ajax({
                url: baseUrl + '/api/containers/{{ container.id }}/start',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        alert('容器已启动');
                        location.reload();
                    } else {
                        alert('启动失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('启动失败');
                }
            });
        }
    });

    // 停止容器
    $('#stopContainer').click(function() {
        if (confirm('确定要停止这个容器吗？')) {
            $.ajax({
                url: baseUrl + '/api/containers/{{ container.id }}/stop',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        alert('容器已停止');
                        location.reload();
                    } else {
                        alert('停止失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('停止失败');
                }
            });
        }
    });

    // 删除容器
    $('#deleteContainer').click(function() {
        if (confirm('确定要删除这个容器吗？此操作不可恢复！')) {
            $.ajax({
                url: baseUrl + '/api/containers/{{ container.id }}',
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        alert('容器已删除');
                        window.location.href = baseUrl + '/containers';
                    } else {
                        alert('删除失败: ' + response.message);
                    }
                },
                error: function() {
                    alert('删除失败');
                }
            });
        }
    });

    // 定时更新资源使用情况
    function updateResourceUsage() {
        if ('{{ container.status }}' === 'running') {
            $.ajax({
                url: baseUrl + '/api/containers/{{ container.id }}/stats',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        var stats = response.data;
                        // 更新CPU使用率
                        if (stats.cpu_usage !== undefined) {
                            $('.progress-bar.bg-primary').css('width', stats.cpu_usage + '%')
                                .attr('aria-valuenow', stats.cpu_usage)
                                .text(stats.cpu_usage.toFixed(1) + '%');
                        }
                        
                        // 更新内存使用
                        if (stats.memory_usage !== undefined && stats.memory_limit !== undefined) {
                            var memoryPercent = (stats.memory_usage / stats.memory_limit) * 100;
                            $('.progress-bar.bg-info').css('width', memoryPercent + '%')
                                .attr('aria-valuenow', memoryPercent)
                                .text(stats.memory_usage + ' MB / ' + stats.memory_limit + ' MB');
                        }
                        
                        // 更新网络I/O
                        if (stats.network_rx !== undefined && stats.network_tx !== undefined) {
                            $('p.form-control-static').html('接收: ' + stats.network_rx + ' MB<br>发送: ' + stats.network_tx + ' MB');
                        }
                    }
                }
            });
        }
    }

    // 每5秒更新一次
    setInterval(updateResourceUsage, 5000);
});
</script>
{% endblock %}