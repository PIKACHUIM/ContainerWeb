{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">用户管理</h1>
                <button class="btn btn-primary" data-toggle="modal" data-target="#createUserModal">
                    <i class="fas fa-plus"></i> 创建用户
                </button>
            </div>

            <!-- 用户列表 -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">用户列表</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="usersTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>邮箱</th>
                                    <th>角色</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>最后登录</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- 用户数据将通过JavaScript加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建用户模态框 -->
<div class="modal fade" id="createUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新用户</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>邮箱</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="form-group">
                        <label>确认密码</label>
                        <input type="password" class="form-control" name="confirm_password" required>
                    </div>
                    <div class="form-group">
                        <label>角色</label>
                        <select class="form-control" name="role" required>
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createUser()">创建用户</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑用户</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" name="id" id="editUserId">
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" class="form-control" name="username" id="editUsername" required>
                    </div>
                    <div class="form-group">
                        <label>邮箱</label>
                        <input type="email" class="form-control" name="email" id="editEmail" required>
                    </div>
                    <div class="form-group">
                        <label>新密码（留空则不修改）</label>
                        <input type="password" class="form-control" name="password">
                    </div>
                    <div class="form-group">
                        <label>角色</label>
                        <select class="form-control" name="role" id="editRole" required>
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <select class="form-control" name="status" id="editStatus" required>
                            <option value="active">活跃</option>
                            <option value="inactive">非活跃</option>
                            <option value="banned">已封禁</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateUser()">保存更改</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    loadUsers();
    
    // 初始化数据表格
    $('#usersTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese.json"
        }
    });
});

// 加载用户列表
function loadUsers() {
    $.ajax({
        url: baseUrl + '/api/admin/users',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                renderUsersTable(response.data);
            } else {
                toastr.error('加载用户列表失败');
            }
        },
        error: function() {
            toastr.error('加载用户列表失败');
        }
    });
}

// 渲染用户表格
function renderUsersTable(users) {
    const tbody = $('#usersTableBody');
    tbody.empty();
    
    users.forEach(function(user) {
        const row = `
            <tr>
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${getRoleBadge(user.role)}</td>
                <td>${getStatusBadge(user.status)}</td>
                <td>${formatDate(user.created_at)}</td>
                <td>${user.last_login ? formatDate(user.last_login) : '从未登录'}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editUser(${user.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 获取角色标签
function getRoleBadge(role) {
    if (role === 'admin') {
        return '<span class="badge badge-danger">管理员</span>';
    }
    return '<span class="badge badge-primary">普通用户</span>';
}

// 获取状态标签
function getStatusBadge(status) {
    const badges = {
        'active': '<span class="badge badge-success">活跃</span>',
        'inactive': '<span class="badge badge-secondary">非活跃</span>',
        'banned': '<span class="badge badge-danger">已封禁</span>'
    };
    return badges[status] || '<span class="badge badge-light">未知</span>';
}

// 创建用户
function createUser() {
    const form = $('#createUserForm')[0];
    const formData = new FormData(form);
    
    // 验证密码匹配
    if (formData.get('password') !== formData.get('confirm_password')) {
        toastr.error('两次输入的密码不匹配');
        return;
    }
    
    $.ajax({
        url: baseUrl + '/api/admin/users',
        method: 'POST',
        data: JSON.stringify({
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            role: formData.get('role')
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                toastr.success('用户创建成功');
                $('#createUserModal').modal('hide');
                form.reset();
                loadUsers();
            } else {
                toastr.error(response.message || '用户创建失败');
            }
        },
        error: function() {
            toastr.error('用户创建失败');
        }
    });
}

// 编辑用户
function editUser(userId) {
    $.ajax({
        url: baseUrl + '/api/admin/users/' + userId,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const user = response.data;
                $('#editUserId').val(user.id);
                $('#editUsername').val(user.username);
                $('#editEmail').val(user.email);
                $('#editRole').val(user.role);
                $('#editStatus').val(user.status);
                $('#editUserModal').modal('show');
            } else {
                toastr.error('获取用户信息失败');
            }
        },
        error: function() {
            toastr.error('获取用户信息失败');
        }
    });
}

// 更新用户
function updateUser() {
    const userId = $('#editUserId').val();
    const formData = new FormData($('#editUserForm')[0]);
    
    $.ajax({
        url: baseUrl + '/api/admin/users/' + userId,
        method: 'PUT',
        data: JSON.stringify({
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            role: formData.get('role'),
            status: formData.get('status')
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                toastr.success('用户更新成功');
                $('#editUserModal').modal('hide');
                loadUsers();
            } else {
                toastr.error(response.message || '用户更新失败');
            }
        },
        error: function() {
            toastr.error('用户更新失败');
        }
    });
}

// 删除用户
function deleteUser(userId) {
    if (confirm('确定要删除这个用户吗？此操作不可恢复。')) {
        $.ajax({
            url: baseUrl + '/api/admin/users/' + userId,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    toastr.success('用户删除成功');
                    loadUsers();
                } else {
                    toastr.error(response.message || '用户删除失败');
                }
            },
            error: function() {
                toastr.error('用户删除失败');
            }
        });
    }
}
</script>
{% endblock %}