{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">模板管理</h1>
                <button class="btn btn-primary" onclick="window.location.href='{{ url_for('templates.create') }}'">
                    <i class="fas fa-plus"></i> 创建模板
                </button>
            </div>

            <!-- 模板列表 -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">系统模板列表</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="templatesTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>名称</th>
                                    <th>镜像</th>
                                    <th>类型</th>
                                    <th>CPU限制</th>
                                    <th>内存限制</th>
                                    <th>存储限制</th>
                                    <th>状态</th>
                                    <th>创建者</th>
                                    <th>创建时间</th>
                                    <th>使用次数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="templatesTableBody">
                                <!-- 模板数据将通过JavaScript加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    loadTemplates();
    
    // 初始化数据表格
    $('#templatesTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Chinese.json"
        }
    });
});

// 加载模板列表
function loadTemplates() {
    $.ajax({
        url: baseUrl + '/api/admin/templates',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                renderTemplatesTable(response.data);
            } else {
                toastr.error('加载模板列表失败');
            }
        },
        error: function() {
            toastr.error('加载模板列表失败');
        }
    });
}

// 渲染模板表格
function renderTemplatesTable(templates) {
    const tbody = $('#templatesTableBody');
    tbody.empty();
    
    templates.forEach(function(template) {
        const row = `
            <tr>
                <td>${template.id}</td>
                <td>${template.name}</td>
                <td>${template.image}</td>
                <td>${getTemplateTypeBadge(template.type)}</td>
                <td>${template.cpu_limit || '-'}</td>
                <td>${template.memory_limit || '-'}</td>
                <td>${template.storage_limit || '-'}</td>
                <td>${getStatusBadge(template.status)}</td>
                <td>${template.creator || '系统'}</td>
                <td>${formatDate(template.created_at)}</td>
                <td>${template.usage_count || 0}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewTemplate(${template.id})" title="查看详情">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="editTemplate(${template.id})" title="编辑">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${template.id})" title="删除">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// 获取模板类型标签
function getTemplateTypeBadge(type) {
    const badges = {
        'web': '<span class="badge badge-primary">Web应用</span>',
        'database': '<span class="badge badge-success">数据库</span>',
        'cache': '<span class="badge badge-warning">缓存</span>',
        'message_queue': '<span class="badge badge-info">消息队列</span>',
        'monitoring': '<span class="badge badge-secondary">监控</span>',
        'development': '<span class="badge badge-dark">开发环境</span>',
        'other': '<span class="badge badge-light">其他</span>'
    };
    return badges[type] || '<span class="badge badge-light">未知</span>';
}

// 获取状态标签
function getStatusBadge(status) {
    const badges = {
        'active': '<span class="badge badge-success">启用</span>',
        'inactive': '<span class="badge badge-secondary">禁用</span>',
        'deprecated': '<span class="badge badge-warning">弃用</span>',
        'private': '<span class="badge badge-info">私有</span>',
        'public': '<span class="badge badge-primary">公开</span>'
    };
    return badges[status] || '<span class="badge badge-light">未知</span>';
}

// 查看模板详情
function viewTemplate(templateId) {
    window.location.href = baseUrl + '/templates/' + templateId;
}

// 编辑模板
function editTemplate(templateId) {
    window.location.href = baseUrl + '/templates/' + templateId + '/edit';
}

// 删除模板
function deleteTemplate(templateId) {
    if (confirm('确定要删除这个模板吗？此操作不可恢复。')) {
        $.ajax({
            url: baseUrl + '/api/admin/templates/' + templateId,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    toastr.success('模板删除成功');
                    loadTemplates();
                } else {
                    toastr.error(response.message || '模板删除失败');
                }
            },
            error: function() {
                toastr.error('模板删除失败');
            }
        });
    }
}
</script>
{% endblock %}